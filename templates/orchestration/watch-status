#!/bin/bash
# Live status monitor for Claude Copilot streams
# Usage: watch-status [interval] [--no-auto-restart]
# Default interval: 15 seconds
#
# Features:
# - Live stream progress display
# - Auto-restart dead workers (disable with --no-auto-restart)
# - Initiative completion detection

INTERVAL=${1:-15}
AUTO_RESTART=true

# Parse arguments
for arg in "$@"; do
    case $arg in
        --no-auto-restart)
            AUTO_RESTART=false
            ;;
        [0-9]*)
            INTERVAL=$arg
            ;;
    esac
done

# Resolve script location to find PROJECT_ROOT and ORCHESTRATOR_DIR
# Handles multiple symlink scenarios:
#   1. Direct call: .claude/orchestrator/watch-status
#   2. Project root symlink: ./watch-status -> .claude/orchestrator/watch-status
#   3. Symlinked orchestrator: .claude/orchestrator/watch-status -> template
INVOCATION_PATH="${BASH_SOURCE[0]}"
INVOCATION_DIR="$(cd "$(dirname "$INVOCATION_PATH")" && pwd)"

# Check if first symlink target contains .claude/orchestrator (project root symlink case)
if [ -L "$INVOCATION_PATH" ]; then
    FIRST_TARGET="$(readlink "$INVOCATION_PATH")"
    if [[ "$FIRST_TARGET" == *".claude/orchestrator"* ]]; then
        # Called from project root via symlink
        PROJECT_ROOT="$INVOCATION_DIR"
        ORCHESTRATOR_DIR="$INVOCATION_DIR/.claude/orchestrator"
    else
        # Called from .claude/orchestrator (which may itself be symlinked)
        PROJECT_ROOT="$(cd "$INVOCATION_DIR/../.." && pwd)"
        ORCHESTRATOR_DIR="$INVOCATION_DIR"
    fi
else
    # Direct call (not a symlink)
    PROJECT_ROOT="$(cd "$INVOCATION_DIR/../.." && pwd)"
    ORCHESTRATOR_DIR="$INVOCATION_DIR"
fi

WORKSPACE_ID=$(basename "$PROJECT_ROOT")

# For finding template scripts (check_streams_data.py, etc.), resolve fully
SCRIPT_PATH="$INVOCATION_PATH"
while [ -L "$SCRIPT_PATH" ]; do
    RESOLVED_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$RESOLVED_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

echo "Starting live status monitor (refresh every ${INTERVAL}s)"
if [ "$AUTO_RESTART" = true ]; then
    echo -e "Auto-restart: ${GREEN}enabled${NC} (use --no-auto-restart to disable)"
else
    echo -e "Auto-restart: ${YELLOW}disabled${NC}"
fi
echo "Press Ctrl-C to stop"
echo ""

while true; do
    # Capture check-streams output (use INVOCATION_DIR so check-streams calculates correct PROJECT_ROOT)
    "$INVOCATION_DIR/check-streams"

    # Monitor and auto-restart dead workers (monitor-workers.py is in project dir, not template)
    if [ "$AUTO_RESTART" = true ]; then
        # Run monitor quietly, only show output if action taken
        MONITOR_OUTPUT=$(python3 "$INVOCATION_DIR/monitor-workers.py" --auto-restart --quiet 2>&1)
        if [ -n "$MONITOR_OUTPUT" ]; then
            echo ""
            echo "$MONITOR_OUTPUT"
        fi
    fi

    # Check if all streams are complete using the data script
    ORCHESTRATOR_DATA=$(python3 "$SCRIPT_DIR/check_streams_data.py" "$WORKSPACE_ID" 2>/dev/null)
    ALL_COMPLETE=$(echo "$ORCHESTRATOR_DATA" | grep -c "^ALL_STREAMS_COMPLETE")

    if [ "$ALL_COMPLETE" -gt 0 ] 2>/dev/null; then
        echo ""
        echo -e "${GREEN}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${GREEN}${BOLD}â•‘                       ğŸ‰ INITIATIVE COMPLETE ğŸ‰                             â•‘${NC}"
        echo -e "${GREEN}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        echo -e "${CYAN}All streams completed. Streams have been archived for this initiative.${NC}"
        echo ""

        # Wait 30 seconds showing countdown
        for i in 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1; do
            echo -ne "\r${CYAN}Clearing in ${i}s... (Ctrl-C to keep viewing)${NC}  "
            sleep 1
        done
        echo ""
        echo ""

        # Clear screen and show ready message
        clear
        echo ""
        echo -e "${GREEN}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${GREEN}${BOLD}â•‘                    Ready for Next Initiative                                â•‘${NC}"
        echo -e "${GREEN}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        echo -e "${CYAN}Previous initiative completed and archived.${NC}"
        echo -e "${CYAN}Run '/orchestrate generate' to start a new initiative.${NC}"
        echo ""
        exit 0
    fi

    echo -e "\n${CYAN}Next refresh in ${INTERVAL}s... (Ctrl-C to stop)${NC}"
    sleep "$INTERVAL"
done
